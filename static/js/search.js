var lunrIndex, pagesIndex;

function endsWith(str, suffix) {
    return str.indexOf(suffix, str.length - suffix.length) !== -1;
}

// Initialize lunrjs using our generated index file
function initLunr() {
    if (!endsWith(baseurl, "/")) {
        baseurl = baseurl + "/";
    }

    // Load the index.json generated by Hugo
    $.getJSON(baseurl + "index.json")
        .done(function (data) {
            pagesIndex = data;

            // Build lunr index client-side
            lunrIndex = lunr(function () {
                this.ref("uri");
                this.field("title", { boost: 10 });
                this.field("tags", { boost: 5 });
                this.field("content");

                data.forEach(function (page) {
                    this.add(page);
                }, this);
            });
        })
        .fail(function (jqxhr, textStatus, error) {
            var err = textStatus + ", " + error;
            console.error("Error getting index.json: ", err);
        });
}

/**
 * Trigger a search in lunr and transform the result
 *
 * @param  {String} query
 * @return {Array}  results
 */
function search(query) {
    if (!lunrIndex) {
        return [];
    }
    return lunrIndex.search(query).map(function (result) {
        return pagesIndex.filter(function (page) {
            return page.uri === result.ref;
        })[0];
    });
}

// Let's get started
initLunr();
$(document).ready(function () {
    var horseyList = horsey($("#search-by").get(0), {
        suggestions: function (value, done) {
            var query = $("#search-by").val();
            var results = search(query);
            done(results);
        },
        filter: function (q, suggestion) {
            return true;
        },
        set: function (value) {
            location.href = value.uri;
        },
        render: function (li, suggestion) {
            var query = $("#search-by").val();
            var numWords = 2;
            var text = suggestion.content.match(
                "(?:\\s?(?:[\\w]+)\\s?){0," + numWords + "}" + query + "(?:\\s?(?:[\\w]+)\\s?){0," + numWords + "}"
            );
            suggestion.context = text;
            var image =
                "<div>" +
                "\u00BB " +
                suggestion.title +
                '</div><div style="font-size:12px">' +
                (suggestion.context || "") +
                "</div>";
            li.innerHTML = image;
        },
        limit: 10,
    });
    horseyList.refreshPosition();
});
